// 직접 테스트 저장 함수 - 이 함수를 Google Apps Script 편집기에서 직접 실행
function runDirectTest() {
  // 테스트 데이터 생성
  var testData = {
    name: "테스트직접실행",
    phone1: "010", 
    phone2: "1234", 
    phone3: "5678",
    concept: "테스트용",
    family_count: "3",
    ages: "테스트연령대",
    date: "2024-07-20",
    message: "직접 테스트 실행"
  };
  
  try {
    // 스프레드시트에 직접 저장 시도
    Logger.log("직접 테스트 저장 시작");
    
    // 스프레드시트 열기
    var spreadsheetId = "1MGp7Y6-ZXnoEo5I0FKo_Jx6SFZIyWzkvfn9WXnYnf1Y";
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName('랜딩페이지_1');
    
    // 시트가 없으면 새로 만들기
    if (!sheet) {
      sheet = spreadsheet.insertSheet('랜딩페이지_1');
      // 헤더 추가
      sheet.appendRow(['접수일시', '예약자명', '연락처', '촬영컨셉', '인원수', '연령대', '희망날짜', '요청사항']);
    }
    
    // 데이터 추가
    var timestamp = new Date();
    var phone = testData.phone1 + '-' + testData.phone2 + '-' + testData.phone3;
    
    sheet.appendRow([
      timestamp,
      testData.name,
      phone,
      testData.concept,
      testData.family_count,
      testData.ages,
      testData.date,
      testData.message
    ]);
    
    Logger.log("직접 테스트 저장 성공");
    return "직접 테스트 저장 성공";
  } catch(error) {
    Logger.log("직접 테스트 저장 실패: " + error);
    return "직접 테스트 저장 실패: " + error;
  }
}

// 간단한 테스트 폼 페이지 생성
function getSimpleTestForm() {
  var html = `
  <!DOCTYPE html>
  <html>
  <head>
    <title>간단한 테스트 폼</title>
    <meta charset="UTF-8">
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; }
      input, select { padding: 8px; width: 100%; box-sizing: border-box; }
      button { padding: 10px 15px; background: #4285f4; color: white; border: none; cursor: pointer; }
    </style>
  </head>
  <body>
    <h2>가족사진 예약 테스트 폼</h2>
    <form id="testForm" method="POST">
      <div class="form-group">
        <label for="name">이름 (필수)</label>
        <input type="text" id="name" name="name" value="테스트이름" required>
      </div>
      
      <div class="form-group">
        <label for="phone">연락처 (필수)</label>
        <div style="display: flex; gap: 10px;">
          <input type="tel" id="phone1" name="phone1" value="010" required style="width: 80px;">
          <input type="tel" id="phone2" name="phone2" value="1234" required style="width: 100px;">
          <input type="tel" id="phone3" name="phone3" value="5678" required style="width: 100px;">
        </div>
      </div>
      
      <div class="form-group">
        <label for="concept">촬영 컨셉 (필수)</label>
        <select id="concept" name="concept" required>
          <option value="casual">자연스러운 일상</option>
          <option value="formal">격식있는 정장</option>
          <option value="hanbok">전통 한복</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="family_count">참여 인원 (필수)</label>
        <select id="family_count" name="family_count" required>
          <option value="2">2명</option>
          <option value="3">3명</option>
          <option value="4" selected>4명</option>
          <option value="5">5명</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="ages">연령대 (필수)</label>
        <input type="text" id="ages" name="ages" value="60대, 30대" required>
      </div>
      
      <div class="form-group">
        <label for="date">희망 날짜</label>
        <input type="date" id="date" name="date" value="2024-07-15">
      </div>
      
      <div class="form-group">
        <label for="message">요청사항</label>
        <textarea id="message" name="message" style="width: 100%; height: 100px;">테스트 메시지입니다.</textarea>
      </div>
      
      <input type="hidden" name="submitted" value="true">
      
      <div class="form-group">
        <button type="button" onclick="submitForm()">제출하기</button>
      </div>
    </form>
    
    <div id="result" style="margin-top: 20px; padding: 10px; background: #f0f0f0; display: none;"></div>
    
    <script>
      function submitForm() {
        const form = document.getElementById('testForm');
        const resultDiv = document.getElementById('result');
        
        // 폼 데이터 수집
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }
        
        // 필수 항목 검사
        if (!data.name || !data.phone1 || !data.phone2 || !data.phone3 || !data.concept || !data.family_count || !data.ages) {
          alert('필수 항목을 모두 입력해주세요.');
          return;
        }
        
        // 결과 표시
        resultDiv.innerHTML = '<h3>제출 중...</h3>';
        resultDiv.style.display = 'block';
        
        // URL 인코딩된 데이터 생성
        const urlEncodedData = new URLSearchParams(formData).toString();
        
        // 데이터 전송
        fetch('${ScriptApp.getService().getUrl()}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: urlEncodedData
        })
        .then(response => {
          console.log('응답 받음:', response);
          return response.text();
        })
        .then(text => {
          console.log('응답 텍스트:', text);
          try {
            const data = JSON.parse(text);
            resultDiv.innerHTML = '<h3>결과</h3>' +
              '<div style="padding: 10px; background: ' + (data.result === 'success' ? '#d4edda' : '#f8d7da') + '; ' +
              'color: ' + (data.result === 'success' ? '#155724' : '#721c24') + '; ' +
              'border-radius: 5px; margin-bottom: 15px;">' +
              data.message + '</div>' +
              '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            
            if (data.result === 'success') {
              alert('예약 정보가 성공적으로 전송되었습니다.');
            }
          } catch (e) {
            resultDiv.innerHTML = '<h3>응답 파싱 오류</h3>' +
              '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 5px; margin-bottom: 15px;">' +
              '응답을 JSON으로 파싱할 수 없습니다.' + '</div>' +
              '<pre>' + text + '</pre>';
            console.error('응답 파싱 오류:', e);
          }
        })
        .catch(error => {
          resultDiv.innerHTML = '<h3>오류 발생</h3>' +
            '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 5px; margin-bottom: 15px;">' +
            error.message + '</div>';
          console.error('에러:', error);
        });
      }
    </script>
  </body>
  </html>
  `;
  
  return HtmlService.createHtmlOutput(html)
    .setTitle('간단한 테스트 폼')
    .setSandboxMode(HtmlService.SandboxMode.IFRAME);
}

// 웹 앱 URL에서 접근할 때 표시될 함수
function doGet() {
  return getSimpleTestForm();
}

// POST 요청 처리 함수
function doPost(e) {
  try {
    // 로깅 추가
    Logger.log("doPost 함수 시작");
    
    // 요청 객체 검사 - 테스트 목적으로 객체가 없으면 테스트 데이터 생성
    if (!e) {
      Logger.log("요청 객체(e)가 없어 테스트 데이터로 대체합니다.");
      e = {
        parameter: {
          name: "테스트 사용자",
          phone1: "010",
          phone2: "1234",
          phone3: "5678",
          concept: "테스트 콘셉트",
          family_count: "4",
          ages: "60대",
          submitted: "true",
          source: "테스트 제출"
        }
      };
    }
    
    // 요청 데이터 확인
    Logger.log("요청 전체: " + JSON.stringify(e));
    
    // 파라미터 확인
    var params = e.parameter || {};
    if (e.postData) {
      try {
        // POST 데이터가 있으면 파싱 시도
        var postData = e.postData.contents;
        var postParams = {};
        
        try {
          // JSON 형식으로 파싱 시도
          postParams = JSON.parse(postData);
        } catch(jsonError) {
          // URL 인코딩 형식으로 파싱 시도
          postParams = parseFormData(postData);
        }
        
        // 파라미터 객체에 병합
        params = Object.assign({}, params, postParams);
      } catch(postError) {
        Logger.log("POST 데이터 파싱 오류: " + postError);
      }
    }
    
    Logger.log("처리할 파라미터: " + JSON.stringify(params));
    
    // 필수 데이터 확인
    if (!params.name || !params.concept || !params.family_count || !params.ages) {
      Logger.log("필수 데이터가 없습니다.");
      return ContentService.createTextOutput(JSON.stringify({
        'result': 'error',
        'message': '필수 데이터가 없습니다. (이름, 컨셉, 인원수, 연령대는 필수입니다)'
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // 특정 스프레드시트 열기
    var spreadsheetId = "1MGp7Y6-ZXnoEo5I0FKo_Jx6SFZIyWzkvfn9WXnYnf1Y";
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName('랜딩페이지_1');
    
    // 시트가 없으면 새로 만들기
    if (!sheet) {
      Logger.log("시트가 없어서 새로 생성합니다");
      sheet = spreadsheet.insertSheet('랜딩페이지_1');
      // 헤더 추가
      sheet.appendRow(['접수일시', '예약자명', '연락처', '촬영컨셉', '인원수', '연령대', '희망날짜', '요청사항', '접수출처']);
    }
    
    // 폼 데이터 처리
    var timestamp = new Date();
    
    // 전화번호 처리
    var phone = "";
    if (params.phone1 && params.phone2 && params.phone3) {
      phone = params.phone1 + "-" + params.phone2 + "-" + params.phone3;
    } else if (params.phone) {
      phone = params.phone;
    } else {
      phone = "연락처 없음";
    }
    
    // 데이터 소스 처리
    var source = params.source || "웹사이트";
    
    // 스프레드시트에 데이터 추가
    sheet.appendRow([
      timestamp,
      params.name,
      phone,
      params.concept,
      params.family_count,
      params.ages,
      params.date || "미지정",
      params.message || "없음",
      source
    ]);
    
    Logger.log("데이터 저장 성공");
    
    // 성공 응답 반환
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'success',
      'message': '데이터가 성공적으로 저장되었습니다.'
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // 오류 로깅
    Logger.log("오류 발생: " + error.toString());
    
    // 오류 응답 반환
    return ContentService.createTextOutput(JSON.stringify({
      'result': 'error',
      'message': error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// URL 인코딩된 폼 데이터 파싱 함수
function parseFormData(formData) {
  var result = {};
  var pairs = formData.split('&');
  
  for (var i = 0; i < pairs.length; i++) {
    var pair = pairs[i].split('=');
    var key = decodeURIComponent(pair[0]);
    var value = pair.length > 1 ? decodeURIComponent(pair[1].replace(/\+/g, ' ')) : '';
    result[key] = value;
  }
  
  return result;
}
