// 직접 테스트 저장 함수 - 이 함수를 Google Apps Script 편집기에서 직접 실행
function runDirectTest() {
  // 테스트 데이터 생성
  var testData = {
    name: "테스트복수콘셉트",
    phone1: "010", 
    phone2: "1234", 
    phone3: "5678",
    combined_concepts: "casual, hanbok",  // 두 개의 콘셉트 테스트
    family_count: "3",
    ages: "테스트연령대",
    date: "2024-07-20",
    message: "복수 콘셉트 테스트"
  };
  
  try {
    // 스프레드시트에 직접 저장 시도
    Logger.log("직접 테스트 저장 시작");
    
    // 스프레드시트 열기
    try {
      var spreadsheetId = "13u4znIx3N9PELsOSCyrtfLNUo5iW8xtmjigEHkw2lYc";
      Logger.log("스프레드시트 ID: " + spreadsheetId);
      
      var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
      Logger.log("스프레드시트 열기 성공: " + spreadsheet.getName());
      
      var sheet = spreadsheet.getSheetByName('랜딩페이지_1');
      
      // 시트가 없으면 새로 만들기
      if (!sheet) {
        Logger.log("시트가 없어서 새로 생성합니다");
        sheet = spreadsheet.insertSheet('랜딩페이지_1');
        // 헤더 추가
        sheet.appendRow(['접수일시', '예약자명', '연락처', '촬영컨셉', '인원수', '연령대', '희망날짜', '요청사항', '접수출처']);
        Logger.log("헤더 추가 완료");
      } else {
        Logger.log("기존 시트 사용: " + sheet.getName());
      }
      
      // 데이터 추가
      var timestamp = new Date();
      var phone = testData.phone1 + '-' + testData.phone2 + '-' + testData.phone3;
      
      // 저장할 데이터 로그
      var rowData = [
        timestamp,
        testData.name,
        phone,
        testData.combined_concepts,
        testData.family_count,
        testData.ages,
        testData.date,
        testData.message,
        "직접 테스트"
      ];
      Logger.log("저장할 데이터: " + JSON.stringify(rowData));
      
      // 스프레드시트에 데이터 추가
      sheet.appendRow(rowData);
      Logger.log("직접 테스트 저장 성공");
      
      // 데이터가 실제로 저장되었는지 확인
      var lastRow = sheet.getLastRow();
      var lastRowData = sheet.getRange(lastRow, 1, 1, 9).getValues()[0];
      Logger.log("마지막 행 데이터: " + JSON.stringify(lastRowData));
      
      return "직접 테스트 저장 성공";
    } catch(sheetError) {
      Logger.log("스프레드시트 작업 중 오류 발생: " + sheetError.toString());
      Logger.log("스택 추적: " + sheetError.stack);
      throw sheetError;
    }
  } catch(error) {
    Logger.log("직접 테스트 저장 실패: " + error.toString());
    Logger.log("스택 추적: " + error.stack);
    return "직접 테스트 저장 실패: " + error.toString();
  }
}

// 간단한 테스트 폼 페이지 생성
function getSimpleTestForm() {
  var html = `
  <!DOCTYPE html>
  <html>
  <head>
    <title>간단한 테스트 폼</title>
    <meta charset="UTF-8">
    <style>
      body { font-family: Arial, sans-serif; margin: 20px; }
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; }
      input, select { padding: 8px; width: 100%; box-sizing: border-box; }
      button { padding: 10px 15px; background: #4285f4; color: white; border: none; cursor: pointer; }
    </style>
  </head>
  <body>
    <h2>가족사진 예약 테스트 폼</h2>
    <form id="testForm" method="POST">
      <div class="form-group">
        <label for="name">이름 (필수)</label>
        <input type="text" id="name" name="name" value="테스트이름" required>
      </div>
      
      <div class="form-group">
        <label for="phone">연락처 (필수)</label>
        <div style="display: flex; gap: 10px;">
          <input type="tel" id="phone1" name="phone1" value="010" required style="width: 80px;">
          <input type="tel" id="phone2" name="phone2" value="1234" required style="width: 100px;">
          <input type="tel" id="phone3" name="phone3" value="5678" required style="width: 100px;">
        </div>
      </div>
      
      <div class="form-group">
        <label for="concept">촬영 컨셉 (필수)</label>
        <select id="concept" name="concept" required>
          <option value="casual">자연스러운 일상</option>
          <option value="formal">격식있는 정장</option>
          <option value="hanbok">전통 한복</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="family_count">참여 인원 (필수)</label>
        <select id="family_count" name="family_count" required>
          <option value="2">2명</option>
          <option value="3">3명</option>
          <option value="4" selected>4명</option>
          <option value="5">5명</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="ages">연령대 (필수)</label>
        <input type="text" id="ages" name="ages" value="60대, 30대" required>
      </div>
      
      <div class="form-group">
        <label for="date">희망 날짜</label>
        <input type="date" id="date" name="date" value="2024-07-15">
      </div>
      
      <div class="form-group">
        <label for="message">요청사항</label>
        <textarea id="message" name="message" style="width: 100%; height: 100px;">테스트 메시지입니다.</textarea>
      </div>
      
      <input type="hidden" name="submitted" value="true">
      
      <div class="form-group">
        <button type="button" onclick="submitForm()">제출하기</button>
      </div>
    </form>
    
    <div id="result" style="margin-top: 20px; padding: 10px; background: #f0f0f0; display: none;"></div>
    
    <script>
      function submitForm() {
        const form = document.getElementById('testForm');
        const resultDiv = document.getElementById('result');
        
        // 폼 데이터 수집
        const formData = new FormData(form);
        const data = {};
        for (let [key, value] of formData.entries()) {
          data[key] = value;
        }
        
        // 필수 항목 검사
        if (!data.name || !data.phone1 || !data.phone2 || !data.phone3 || !data.concept || !data.family_count || !data.ages) {
          alert('필수 항목을 모두 입력해주세요.');
          return;
        }
        
        // 결과 표시
        resultDiv.innerHTML = '<h3>제출 중...</h3>';
        resultDiv.style.display = 'block';
        
        // URL 인코딩된 데이터 생성
        const urlEncodedData = new URLSearchParams(formData).toString();
        
        // 데이터 전송
        fetch('${ScriptApp.getService().getUrl()}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: urlEncodedData
        })
        .then(response => {
          console.log('응답 받음:', response);
          return response.text();
        })
        .then(text => {
          console.log('응답 텍스트:', text);
          try {
            const data = JSON.parse(text);
            resultDiv.innerHTML = '<h3>결과</h3>' +
              '<div style="padding: 10px; background: ' + (data.result === 'success' ? '#d4edda' : '#f8d7da') + '; ' +
              'color: ' + (data.result === 'success' ? '#155724' : '#721c24') + '; ' +
              'border-radius: 5px; margin-bottom: 15px;">' +
              data.message + '</div>' +
              '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
            
            if (data.result === 'success') {
              alert('예약 정보가 성공적으로 전송되었습니다.');
            }
          } catch (e) {
            resultDiv.innerHTML = '<h3>응답 파싱 오류</h3>' +
              '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 5px; margin-bottom: 15px;">' +
              '응답을 JSON으로 파싱할 수 없습니다.' + '</div>' +
              '<pre>' + text + '</pre>';
            console.error('응답 파싱 오류:', e);
          }
        })
        .catch(error => {
          resultDiv.innerHTML = '<h3>오류 발생</h3>' +
            '<div style="padding: 10px; background: #f8d7da; color: #721c24; border-radius: 5px; margin-bottom: 15px;">' +
            error.message + '</div>';
          console.error('에러:', error);
        });
      }
    </script>
  </body>
  </html>
  `;
  
  return HtmlService.createHtmlOutput(html)
    .setTitle('간단한 테스트 폼')
    .setSandboxMode(HtmlService.SandboxMode.IFRAME);
}

// 웹 앱 URL에서 접근할 때 표시될 함수
function doGet() {
  return getSimpleTestForm();
}

// POST 요청 처리 함수
function doPost(e) {
  try {
    // 로깅 추가
    Logger.log("doPost 함수 시작");
    Logger.log("요청 전체 내용: " + JSON.stringify(e));
    
    // 요청 객체 검사 - 테스트 목적으로 객체가 없으면 테스트 데이터 생성
    if (!e) {
      Logger.log("요청 객체(e)가 없어 테스트 데이터로 대체합니다.");
      e = {
        parameter: {
          name: "테스트 사용자",
          phone1: "010",
          phone2: "1234",
          phone3: "5678",
          combined_concepts: "casual, formal",
          family_count: "4",
          ages: "60대",
          submitted: "true",
          source: "테스트 제출"
        }
      };
    }
    
    // 요청 데이터 확인
    Logger.log("요청 전체: " + JSON.stringify(e));
    
    // 파라미터 확인
    var params = e.parameter || {};
    if (e.postData) {
      try {
        // POST 데이터가 있으면 파싱 시도
        var postData = e.postData.contents;
        Logger.log("POST 데이터 내용: " + postData);
        var postParams = {};
        
        try {
          // JSON 형식으로 파싱 시도
          postParams = JSON.parse(postData);
          Logger.log("JSON으로 파싱 성공: " + JSON.stringify(postParams));
        } catch(jsonError) {
          Logger.log("JSON 파싱 실패, URL 인코딩 형식으로 시도: " + jsonError);
          // URL 인코딩 형식으로 파싱 시도
          postParams = parseFormData(postData);
          Logger.log("URL 인코딩 파싱 결과: " + JSON.stringify(postParams));
        }
        
        // 파라미터 객체에 병합
        params = Object.assign({}, params, postParams);
        Logger.log("병합된 파라미터: " + JSON.stringify(params));
      } catch(postError) {
        Logger.log("POST 데이터 파싱 오류: " + postError);
        Logger.log("POST 데이터 내용: " + e.postData.contents);
      }
    }
    
    Logger.log("처리할 파라미터: " + JSON.stringify(params));
    Logger.log("combined_concepts 값: " + params.combined_concepts);
    Logger.log("concept 값: " + params.concept);
    Logger.log("concept_select 값: " + params.concept_select);
    
    // 필수 데이터 확인
    if (!params.name) {
      Logger.log("이름 필드가 없습니다.");
      return createJsonResponse({
        'result': 'error',
        'message': '이름 필드가 없습니다.'
      });
    }
    
    // 특정 스프레드시트 열기
    try {
      var spreadsheetId = "13u4znIx3N9PELsOSCyrtfLNUo5iW8xtmjigEHkw2lYc";
      Logger.log("스프레드시트 ID: " + spreadsheetId);
      
      var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
      Logger.log("스프레드시트 열기 성공: " + spreadsheet.getName());
      
      var sheet = spreadsheet.getSheetByName('랜딩페이지_1');
      
      // 시트가 없으면 새로 만들기
      if (!sheet) {
        Logger.log("시트가 없어서 새로 생성합니다");
        sheet = spreadsheet.insertSheet('랜딩페이지_1');
        // 헤더 추가
        sheet.appendRow(['접수일시', '예약자명', '연락처', '촬영컨셉', '인원수', '연령대', '희망날짜', '요청사항', '접수출처']);
        Logger.log("헤더 추가 완료");
      } else {
        Logger.log("기존 시트 사용: " + sheet.getName());
      }
      
      // 폼 데이터 처리
      var timestamp = new Date();
      
      // 전화번호 처리
      var phone = "";
      if (params.phone1 && params.phone2 && params.phone3) {
        phone = params.phone1 + "-" + params.phone2 + "-" + params.phone3;
      } else if (params.phone) {
        phone = params.phone;
      } else {
        phone = "연락처 없음";
      }
      Logger.log("처리된 전화번호: " + phone);
      
      // 콘셉트 처리
      var concept = "";
      
      // combined_concepts 필드 우선 확인
      if (params.combined_concepts && params.combined_concepts.trim() !== "") {
        // combined_concepts가 있을 경우 우선 사용 (여러 콘셉트가 합쳐진 필드)
        concept = params.combined_concepts;
        Logger.log("★★★ combined_concepts 사용: " + concept);
      } 
      // concept_select 값이 있는지 확인
      else if (params.concept_select) {
        // concept_select 필드 처리
        if (Array.isArray(params.concept_select)) {
          concept = params.concept_select.join(", ");
          Logger.log("Array concept_select 값: " + concept);
        } else {
          concept = params.concept_select;
          Logger.log("String concept_select 값: " + concept);
        }
      }
      // 마지막으로 기존 concept 필드 확인
      else if (params.concept) {
        // 이전 버전과의 호환성을 위해 기존 concept 필드도 지원
        if (Array.isArray(params.concept)) {
          concept = params.concept.join(", ");
          Logger.log("Array concept 값: " + concept);
        } else {
          concept = params.concept;
          Logger.log("String concept 값: " + concept);
        }
      } else {
        concept = "미지정";
        Logger.log("콘셉트 미지정");
      }
      
      // 디버깅: 변환 전 콘셉트 값 확인
      Logger.log("변환 전 콘셉트 값: " + concept);
      
      // 콘셉트 코드를 한글로 변환
      var koreanConcept = translateConceptToKorean(concept);
      
      // 디버깅: 변환 후 콘셉트 값 확인
      Logger.log("변환 후 콘셉트 값: " + koreanConcept);
      
      // 데이터 소스 처리
      var source = params.source || "웹사이트";
      
      // 저장할 데이터 로그
      var rowData = [
        timestamp,
        params.name,
        phone,
        koreanConcept,  // 한글로 변환된 콘셉트 사용
        params.family_count,
        params.ages,
        params.date || "미지정",
        params.message || "없음",
        source
      ];
      Logger.log("저장할 데이터: " + JSON.stringify(rowData));
      
      // 스프레드시트에 데이터 추가
      sheet.appendRow(rowData);
      Logger.log("데이터 저장 성공");
      
      // 추가 검증: 데이터가 정상적으로 추가되었는지 확인
      var lastRow = sheet.getLastRow();
      var lastRowData = sheet.getRange(lastRow, 1, 1, 9).getValues()[0];
      Logger.log("마지막 행에 저장된 데이터: " + JSON.stringify(lastRowData));
      
      // 성공 응답 반환
      var responseData = {
        'result': 'success',
        'message': '데이터가 성공적으로 저장되었습니다.',
        'data': {
          'name': params.name,
          'phone': phone,
          'concept': koreanConcept,
          'timestamp': timestamp.toString()
        }
      };
      
      Logger.log("성공 응답 데이터: " + JSON.stringify(responseData));
      return createJsonResponse(responseData);
    } catch (sheetError) {
      Logger.log("스프레드시트 작업 중 오류 발생: " + sheetError.toString());
      Logger.log("스택 추적: " + sheetError.stack);
      return createJsonResponse({
        'result': 'error',
        'message': '스프레드시트 작업 중 오류가 발생했습니다: ' + sheetError.toString()
      });
    }
  } catch (error) {
    // 오류 로깅
    Logger.log("오류 발생: " + error.toString());
    Logger.log("스택 추적: " + error.stack);
    
    // 오류 응답 반환
    return createJsonResponse({
      'result': 'error',
      'message': error.toString()
    });
  }
}

// CORS 헤더를 포함한 JSON 응답 생성 함수
function createJsonResponse(data) {
  var response = ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
  
  // CORS 헤더 설정
  var headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  };
  
  for (var header in headers) {
    response.addHeader(header, headers[header]);
  }
  
  Logger.log("응답 생성 완료: " + response.getContent());
  return response;
}

// OPTIONS 요청에 대한 CORS 설정 (프리플라이트 요청 처리)
function doOptions(e) {
  var response = ContentService.createTextOutput("");
  
  // CORS 헤더 설정
  var headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Max-Age': '86400'
  };
  
  for (var header in headers) {
    response.addHeader(header, headers[header]);
  }
  
  return response;
}

// URL 인코딩된 폼 데이터 파싱 함수
function parseFormData(formData) {
  var result = {};
  var pairs = formData.split('&');
  
  for (var i = 0; i < pairs.length; i++) {
    var pair = pairs[i].split('=');
    var key = decodeURIComponent(pair[0]);
    var value = pair.length > 1 ? decodeURIComponent(pair[1].replace(/\+/g, ' ')) : '';
    result[key] = value;
  }
  
  return result;
}

// 스프레드시트 액세스 권한 테스트 함수
function testSpreadsheetAccess() {
  try {
    Logger.log("스프레드시트 액세스 테스트 시작");
    
    // 현재 사용자 확인
    var userEmail = Session.getActiveUser().getEmail();
    Logger.log("현재 실행 사용자: " + userEmail);
    
    // 스프레드시트 열기
    var spreadsheetId = "13u4znIx3N9PELsOSCyrtfLNUo5iW8xtmjigEHkw2lYc";
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    Logger.log("스프레드시트 이름: " + spreadsheet.getName());
    
    // 모든 시트 목록 확인
    var allSheets = spreadsheet.getSheets();
    Logger.log("스프레드시트 내 시트 수: " + allSheets.length);
    for (var i = 0; i < allSheets.length; i++) {
      Logger.log("시트 " + (i+1) + " 이름: " + allSheets[i].getName());
    }
    
    // 새 시트 생성 시도
    var testSheet = spreadsheet.getSheetByName('테스트시트');
    if (!testSheet) {
      testSheet = spreadsheet.insertSheet('테스트시트');
      Logger.log("테스트 시트 생성 성공");
    } else {
      Logger.log("기존 테스트 시트 사용");
    }
    
    // 테스트 데이터 쓰기
    testSheet.getRange("A1").setValue("테스트 데이터 " + new Date());
    Logger.log("테스트 데이터 쓰기 성공");
    
    return "스프레드시트 액세스 테스트 성공";
  } catch (error) {
    Logger.log("스프레드시트 액세스 테스트 실패: " + error.toString());
    Logger.log("스택 추적: " + error.stack);
    return "스프레드시트 액세스 테스트 실패: " + error.toString();
  }
}

// 스프레드시트의 모든 시트와 데이터를 확인하는 함수
function checkAllSheetsAndData() {
  try {
    Logger.log("스프레드시트 확인 시작");
    
    var spreadsheetId = "13u4znIx3N9PELsOSCyrtfLNUo5iW8xtmjigEHkw2lYc";
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    Logger.log("스프레드시트 이름: " + spreadsheet.getName());
    
    // 모든 시트 확인
    var allSheets = spreadsheet.getSheets();
    Logger.log("총 시트 수: " + allSheets.length);
    
    for (var i = 0; i < allSheets.length; i++) {
      var sheet = allSheets[i];
      var sheetName = sheet.getName();
      Logger.log("시트 " + (i+1) + ": " + sheetName);
      
      // 시트의 데이터 확인
      var lastRow = sheet.getLastRow();
      var lastColumn = sheet.getLastColumn();
      
      Logger.log("시트 '" + sheetName + "'의 마지막 행: " + lastRow + ", 마지막 열: " + lastColumn);
      
      if (lastRow > 0 && lastColumn > 0) {
        // 시트에 데이터가 있는 경우
        Logger.log("시트 '" + sheetName + "'에 데이터가 있습니다.");
        
        // 헤더 확인 (첫 번째 행)
        if (lastRow >= 1) {
          var headers = sheet.getRange(1, 1, 1, lastColumn).getValues()[0];
          Logger.log("헤더: " + JSON.stringify(headers));
        }
        
        // 마지막 행의 데이터 확인
        if (lastRow > 1) {
          var lastRowData = sheet.getRange(lastRow, 1, 1, lastColumn).getValues()[0];
          Logger.log("마지막 행 데이터: " + JSON.stringify(lastRowData));
        }
      } else {
        Logger.log("시트 '" + sheetName + "'에 데이터가 없습니다.");
      }
    }
    
    // 랜딩페이지_1 시트 찾기
    var targetSheet = spreadsheet.getSheetByName('랜딩페이지_1');
    if (targetSheet) {
      Logger.log("랜딩페이지_1 시트를 찾았습니다.");
      
      var lastRow = targetSheet.getLastRow();
      var lastColumn = targetSheet.getLastColumn();
      
      if (lastRow > 1) {
        Logger.log("랜딩페이지_1 시트에 " + (lastRow - 1) + "개의 데이터가 있습니다.");
        
        // 데이터 내용을 직접 확인
        var dataRange = targetSheet.getRange(2, 1, lastRow - 1, lastColumn);
        var values = dataRange.getValues();
        
        for (var i = 0; i < values.length; i++) {
          Logger.log("행 " + (i + 2) + ": " + JSON.stringify(values[i]));
        }
      } else {
        Logger.log("랜딩페이지_1 시트에 데이터가 없습니다 (헤더만 있음).");
      }
    } else {
      Logger.log("랜딩페이지_1 시트를 찾을 수 없습니다.");
    }
    
    return "스프레드시트 확인 완료";
  } catch (error) {
    Logger.log("스프레드시트 확인 중 오류 발생: " + error.toString());
    Logger.log("스택 추적: " + error.stack);
    return "스프레드시트 확인 실패: " + error.toString();
  }
}

// 콘셉트 코드를 한글 이름으로 변환하는 함수
function translateConceptToKorean(conceptCode) {
  // 콘셉트 코드에 따른 한글 이름 매핑
  var conceptMap = {
    "casual": "자연스러운 일상",
    "formal": "격식있는 정장",
    "hanbok": "전통 한복",
    "anniversary": "복고컨셉"
  };
  
  Logger.log("translateConceptToKorean 함수 호출됨, 입력값: " + conceptCode);
  
  // 콘셉트 코드가 배열인 경우 처리
  if (Array.isArray(conceptCode)) {
    Logger.log("배열 형태의 콘셉트 처리");
    var koreanConcepts = [];
    for (var i = 0; i < conceptCode.length; i++) {
      var code = conceptCode[i].trim();
      koreanConcepts.push(conceptMap[code] || code);
    }
    return koreanConcepts.join(", ");
  }
  
  // 콘셉트 코드가 콤마로 구분된 문자열인 경우 처리
  if (typeof conceptCode === 'string' && conceptCode.indexOf(',') > -1) {
    Logger.log("콤마로 구분된 문자열 형태의 콘셉트 처리: " + conceptCode);
    var codes = conceptCode.split(',');
    var koreanConcepts = [];
    for (var i = 0; i < codes.length; i++) {
      var code = codes[i].trim();
      Logger.log("개별 코드 처리: '" + code + "' -> '" + (conceptMap[code] || code) + "'");
      koreanConcepts.push(conceptMap[code] || code);
    }
    var result = koreanConcepts.join(", ");
    Logger.log("최종 변환 결과: " + result);
    return result;
  }
  
  // 단일 콘셉트 코드인 경우 처리
  var result = conceptMap[conceptCode] || conceptCode;
  Logger.log("단일 콘셉트 처리 결과: " + result);
  return result;
}

// 랜딩페이지 폼 테스트 함수
function testLandingPageForm() {
  // 랜딩페이지에서 보낼 수 있는 형태의 데이터 생성
  var testData = {
    name: "테스트랜딩페이지",
    phone1: "010", 
    phone2: "1234", 
    phone3: "5678",
    combined_concepts: "casual, formal",
    concept_select: ["casual", "formal"],  // 체크박스 형태로 전송될 수 있음
    family_count: "4",
    ages: "60대, 70대",
    date: "2024-07-30",
    message: "랜딩페이지 폼 테스트",
    submitted: "true",
    source: "index_2_html"
  };
  
  // URL 형식으로 인코딩된 폼 데이터 생성 (실제 form submit과 유사하게)
  var formDataParts = [];
  for (var key in testData) {
    if (Array.isArray(testData[key])) {
      // 배열인 경우 여러 항목으로 추가
      for (var i = 0; i < testData[key].length; i++) {
        formDataParts.push(encodeURIComponent(key) + "=" + encodeURIComponent(testData[key][i]));
      }
    } else {
      formDataParts.push(encodeURIComponent(key) + "=" + encodeURIComponent(testData[key]));
    }
  }
  var formDataString = formDataParts.join("&");
  
  // 테스트 요청 객체 생성
  var testRequest = {
    parameter: testData,
    postData: {
      contents: formDataString,
      type: "application/x-www-form-urlencoded",
      length: formDataString.length
    }
  };
  
  Logger.log("테스트 요청 객체 생성: " + JSON.stringify(testRequest));
  
  try {
    // doPost 함수 직접 호출
    var response = doPost(testRequest);
    Logger.log("응답 내용: " + response.getContent());
    return "랜딩페이지 폼 테스트 완료: " + response.getContent();
  } catch (error) {
    Logger.log("테스트 중 오류 발생: " + error.toString());
    Logger.log("스택 추적: " + error.stack);
    return "테스트 실패: " + error.toString();
  }
}

// 긴급 복구 테스트 - 스프레드시트에 직접 데이터 추가
function emergencyDataAdd() {
  try {
    Logger.log("긴급 데이터 추가 시작");
    
    var spreadsheetId = "13u4znIx3N9PELsOSCyrtfLNUo5iW8xtmjigEHkw2lYc";
    var spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    var sheet = spreadsheet.getSheetByName('랜딩페이지_1');
    
    if (!sheet) {
      Logger.log("시트가 없어서 새로 생성합니다");
      sheet = spreadsheet.insertSheet('랜딩페이지_1');
      sheet.appendRow(['접수일시', '예약자명', '연락처', '촬영컨셉', '인원수', '연령대', '희망날짜', '요청사항', '접수출처']);
    }
    
    // 테스트 데이터 추가
    var rowData = [
      new Date(),
      "긴급복구테스트",
      "010-1234-5678",
      "자연스러운 일상, 복고컨셉",
      "4",
      "60대, 70대",
      "2024-08-01",
      "긴급 테스트 데이터",
      "긴급복구"
    ];
    
    sheet.appendRow(rowData);
    Logger.log("긴급 테스트 데이터 추가 성공");
    
    // 추가 확인
    var lastRow = sheet.getLastRow();
    var lastRowData = sheet.getRange(lastRow, 1, 1, 9).getValues()[0];
    Logger.log("마지막 행 데이터: " + JSON.stringify(lastRowData));
    
    return "긴급 데이터 추가 성공";
  } catch (error) {
    Logger.log("긴급 데이터 추가 실패: " + error.toString());
    Logger.log("스택 추적: " + error.stack);
    return "긴급 데이터 추가 실패: " + error.toString();
  }
} 
